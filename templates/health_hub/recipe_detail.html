{% extends "health_hub/base.html" %}

{% block content %}
<main style="">
    <!-- レシピ詳細 -->
    <article class="recipe-detail">
      <div class="container">
        <!-- パンくずリスト -->
        <div class="breadcrumbs" style="">
          <a href="/health-hub">ホーム</a> &gt;
          <a href="/health-hub/recipes">レシピ</a> &gt;
          <span>{{ object.title }}</span>
        </div>

        <!-- レシピヘッダー -->
        <div class="recipe-header">
          <div class="recipe-title">
            <h1>{{ object.title }}</h1>
          </div>

          <div class="recipe-actions">
            <button class="btn-icon favorite-btn" aria-label="お気に入りに追加">
              <i class="far fa-heart"></i>
            </button>
            <div class="recipe-share">
              <button class="btn-icon share-btn" aria-label="シェア">
                <i class="fas fa-share-alt"></i>
              </button>
              <div class="share-dropdown">
                <a href="#" aria-label="Twitterでシェア"><i class="fab fa-twitter"></i></a>
                <a href="#" aria-label="Facebookでシェア"><i class="fab fa-facebook-f"></i></a>
                <a href="#" aria-label="Instagramでシェア"><i class="fab fa-instagram"></i></a>
                <a href="#" aria-label="LINEでシェア"><i class="fab fa-line"></i></a>
              </div>
            </div>
            <button class="btn-icon print-btn" aria-label="印刷">
              <i class="fas fa-print"></i>
            </button>
          </div>
        </div>

        <!-- レシピメイン -->
        <div class="recipe-main">
          {% if object.image %}
            <div class="recipe-image-container">
              <img src="{{ object.image.url }}" alt="{{ object.title }}の画像" class="recipe-main-image">
            </div>
            {% endif %}
          <p class="recipe-subtitle">{{ object.description|linebreaksbr }}</p>
          <div class="recipe-info">
            <div class="info-item">
              <i class="far fa-clock"></i>
              <div>
                <span class="info-label">調理時間</span>
                <span class="info-value">{{ object.prep_time }}分</span>
              </div>
            </div>
            <div class="info-item">
              <i class="fas fa-fire"></i>
              <div>
                <span class="info-label">カロリー</span>
                <span class="info-value">{{ object.total_calories }}kcal</span>
              </div>
            </div>
            <div class="info-item">
              <i class="fas fa-dumbbell"></i>
              <div>
                <span class="info-label">タンパク質</span>
                <span class="info-value">{{ object.total_protein }}g</span>
              </div>
            </div>
            <div class="info-item">
              <i class="fas fa-chart-pie"></i>
              <div>
                <span class="info-label">難易度</span>
                <span class="info-value">{{ object.difficulty }}</span>
              </div>
            </div>
          </div>

          <div class="recipe-tags" style="margin-top: 1rem; margin-bottom: 1rem;">
            {% for tag in object.tags.all %}
              <span class="recipe-tag"><a href="/health-hub/recipes/search/?tags={{ tag.slug }}" style="color: white;">{{ tag.name }}</a></span>
            {% endfor %}
          </div>

          <div class="recipe-content">
            <div>
              <div class="ingredients-section">
                <h2>材料 <span class="servings">({{ object.size }}人分)</span></h2>
                <div class="servings-control">
                  <button class="servings-btn" data-action="decrease">-</button>
                  <span class="servings-value">{{ object.size }}</span>
                  <button class="servings-btn" data-action="increase">+</button>
                  <span class="servings-text">人分</span>
                </div>
                <ul class="ingredients-list">
                  {% for ingredient in object.ingredients.all %}
                  <li>
                    <span class="ingredient-name">{{ ingredient.meal_item.name }}</span>
                    <span class="ingredient-amount">{{ ingredient.quantity }}{{ ingredient.meal_item.unit }}</span>
                  </li>
                  {% endfor %}
                </ul>
              </div>

              <div class="nutrition-section">
                <h2>栄養成分表示</h2>
                <div class="nutrition-table">
                  <div class="nutrition-row">
                    <span class="nutrition-name">カロリー</span>
                    <span class="nutrition-value">{{ object.total_calories }}kcal</span>
                  </div>
                  <div class="nutrition-row">
                    <span class="nutrition-name">タンパク質</span>
                    <span class="nutrition-value">{{ object.total_protein }}g</span>
                  </div>
                  <div class="nutrition-row">
                    <span class="nutrition-name">脂質</span>
                    <span class="nutrition-value">{{ object.total_fat }}g</span>
                  </div>
                  <div class="nutrition-row">
                    <span class="nutrition-name">炭水化物</span>
                    <span class="nutrition-value">{{ object.total_carbs }}g</span>
                  </div>
                  {% comment %} <div class="nutrition-row" style="padding-left: 2rem;">
                    <span class="nutrition-name">糖質</span>
                    <span class="nutrition-value">15g</span>
                  </div>
                  <div class="nutrition-row" style="padding-left: 2rem;">
                    <span class="nutrition-name">食物繊維</span>
                    <span class="nutrition-value">5g</span>
                  </div> {% endcomment %}

                </div>
                <p class="nutrition-note">※1人分あたりの概算値です。</p>
                {% comment %} <div class="nutrition-chart">
                  <h3>PFCバランス</h3>
                  <div class="chart-container">
                    <canvas id="pfc-chart" width="250" height="250"></canvas>
                    <div class="chart-legend">
                      <div class="legend-item">
                        <span class="legend-color" style="background-color: rgba(255, 122, 0, 0.7);"></span>
                        <span class="legend-text">このレシピ</span>
                      </div>
                      <div class="legend-item">
                        <span class="legend-color" style="background-color: rgba(255, 122, 0, 0.2);"></span>
                        <span class="legend-text">理想的なバランス</span>
                      </div>
                    </div>
                  </div>
                  <p class="chart-note">P:タンパク質 / F:脂質 / C:炭水化物</p>
                </div> {% endcomment %}
              </div>
            </div>

            <div>
              <div class="instructions-section">
                <h2>作り方</h2>
                <ol class="instructions-list">
                  {% for step in object.steps.all %}
                      <li>
                      <div class="instruction-step">
                          <span class="step-number">{{ step.step_number }}</span>
                          <div class="step-content">
                          <p>{{ step.description|linebreaksbr }}</p>
                          {% if step.image %}
                              <div class="step-image" style="max-height: 450px;">
                                  <img style="height: 100%;" src="{{ step.image.url }}" alt="手順の画像">
                              </div>
                          {% endif %}
                          </div>
                      </div>
                      </li>
                  {% endfor %}
                </ol>
              </div>
              <div class="tips-section">
                <h2>調理のコツ</h2>
                <ul class="tips-list">
                  {% for tip in object.tips.all %}
                      <li><i class="fas fa-lightbulb"></i> {{ tip.tip_text|linebreaksbr }}</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
          </div>
        </div>

        {% comment %} レビューと関連レシピは一旦コメントアウト {% endcomment %}
        {% comment %} <!-- レビューセクション -->
        <div class="review-section">
          <h2>レビュー・コメント</h2>

          <div class="rating-summary">
            <div class="average-rating">
              <div class="rating-number">4.8</div>
              <div class="rating-stars">
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star"></i>
                <i class="fas fa-star-half-alt"></i>
              </div>
              <div class="rating-count">24件のレビュー</div>
            </div>

            <div class="rating-distribution">
              <div class="rating-bar">
                <span class="rating-label">5</span>
                <div class="bar-container">
                  <div class="bar" style="width: 80%;"></div>
                </div>
                <span class="rating-percent">80%</span>
              </div>
              <div class="rating-bar">
                <span class="rating-label">4</span>
                <div class="bar-container">
                  <div class="bar" style="width: 15%;"></div>
                </div>
                <span class="rating-percent">15%</span>
              </div>
              <div class="rating-bar">
                <span class="rating-label">3</span>
                <div class="bar-container">
                  <div class="bar" style="width: 5%;"></div>
                </div>
                <span class="rating-percent">5%</span>
              </div>
              <div class="rating-bar">
                <span class="rating-label">2</span>
                <div class="bar-container">
                  <div class="bar" style="width: 0%;"></div>
                </div>
                <span class="rating-percent">0%</span>
              </div>
              <div class="rating-bar">
                <span class="rating-label">1</span>
                <div class="bar-container">
                  <div class="bar" style="width: 0%;"></div>
                </div>
                <span class="rating-percent">0%</span>
              </div>
            </div>
          </div>

          <div class="review-form">
            <h3>レビューを書く</h3>
            <div class="rating-input">
              <span>評価：</span>
              <div class="star-rating">
                <i class="far fa-star" data-rating="1"></i>
                <i class="far fa-star" data-rating="2"></i>
                <i class="far fa-star" data-rating="3"></i>
                <i class="far fa-star" data-rating="4"></i>
                <i class="far fa-star" data-rating="5"></i>
              </div>
            </div>
            <div class="form-group">
              <label for="review-name">名前</label>
              <input type="text" id="review-name" placeholder="名前を入力">
            </div>
            <div class="form-group">
              <label for="review-comment">コメント</label>
              <textarea id="review-comment" placeholder="レシピについてのコメントを入力"></textarea>
            </div>
            <button class="btn btn-primary">投稿する</button>
          </div>

          <div class="reviews-list">
            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-name">田中 健太</div>
                  <div class="review-date">2025年2月15日</div>
                </div>
                <div class="review-rating">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                </div>
              </div>
              <div class="review-content">
                <p>朝食に作りました。プロテインの量が多すぎると粉っぽくなるので、レシピ通りの量がベストです。バナナの甘みだけで十分美味しいです！トレーニング後の食事にぴったりです。</p>
              </div>
            </div>

            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-name">佐藤 美咲</div>
                  <div class="review-date">2025年2月10日</div>
                </div>
                <div class="review-rating">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                </div>
              </div>
              <div class="review-content">
                <p>ダイエット中ですが、これなら罪悪感なく食べられます。ブルーベリーとヨーグルトをトッピングにして食べています。子供たちも気に入ってくれました！</p>
              </div>
            </div>

            <div class="review-item">
              <div class="review-header">
                <div class="reviewer-info">
                  <div class="reviewer-name">鈴木 大輔</div>
                  <div class="review-date">2025年2月5日</div>
                </div>
                <div class="review-rating">
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="fas fa-star"></i>
                  <i class="far fa-star"></i>
                </div>
              </div>
              <div class="review-content">
                <p>プロテインパウダーをチョコレート味に変えて作ってみました。少し甘みが足りなかったので、メープルシロップを追加しました。全体的には満足です。</p>
              </div>
            </div>

            <button class="btn btn-outline load-more-reviews">すべてのレビューを見る</button>
          </div>
        </div>

        <!-- 関連レシピ -->
        <div class="related-recipes">
          <h2>関連レシピ</h2>
          <div class="related-grid">
            <div class="recipe-card">
              <div class="recipe-image">
                <img src="/media/public/recipes_header_img.webp?text=Related+1" alt="プロテインスムージーボウル">
                <div class="recipe-time"><i class="far fa-clock"></i> 10分</div>
              </div>
              <div class="recipe-content">
                <div class="recipe-tags">
                  <span class="recipe-tag">朝食</span>
                  <span class="recipe-tag">高タンパク</span>
                </div>
                <h3>プロテインスムージーボウル</h3>
                <p class="recipe-desc">朝食やトレーニング後の栄養補給に最適なスムージーボウル。</p>
                <a href="#" class="btn btn-outline btn-sm">詳細を見る</a>
              </div>
            </div>

            <div class="recipe-card">
              <div class="recipe-image">
                <img src="/media/public/recipes_header_img.webp?text=Related+2" alt="オートミールクッキー">
                <div class="recipe-time"><i class="far fa-clock"></i> 25分</div>
              </div>
              <div class="recipe-content">
                <div class="recipe-tags">
                  <span class="recipe-tag">おやつ</span>
                  <span class="recipe-tag">ヘルシー</span>
                </div>
                <h3>プロテイン入りオートミールクッキー</h3>
                <p class="recipe-desc">罪悪感なしで楽しめる、ヘルシーなオートミールクッキー。</p>
                <a href="#" class="btn btn-outline btn-sm">詳細を見る</a>
              </div>
            </div>

            <div class="recipe-card">
              <div class="recipe-image">
                <img src="/media/public/recipes_header_img.webp?text=Related+3" alt="バナナブレッド">
                <div class="recipe-time"><i class="far fa-clock"></i> 60分</div>
              </div>
              <div class="recipe-content">
                <div class="recipe-tags">
                  <span class="recipe-tag">朝食</span>
                  <span class="recipe-tag">おやつ</span>
                </div>
                <h3>プロテインバナナブレッド</h3>
                <p class="recipe-desc">熟したバナナを使った、しっとり食感のプロテインバナナブレッド。</p>
                <a href="#" class="btn btn-outline btn-sm">詳細を見る</a>
              </div>
            </div>
          </div>
        </div> {% endcomment %}
      </div>
    </article>
  </main>

<style>
    /* レシピヘッダー */
    .recipe-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 30px;
    }

    .recipe-title {
    flex: 1;
    }

    .recipe-title h1 {
    font-size: 2.5rem;
    margin: 10px 0;
    line-height: 1.2;
    }

    .recipe-subtitle {
    color: var(--text-light);
    font-size: 1.1rem;
    max-width: 700px;
    }

    .recipe-actions {
    display: flex;
    gap: 15px;
    }

    .btn-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--background-alt);
    border: none;
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    }

    .btn-icon:hover {
    background-color: var(--primary-light);
    color: white;
    }

    .favorite-btn.active {
    background-color: var(--primary);
    color: white;
    }

    .favorite-btn.active i {
    font-weight: 900;
    }

    .recipe-share {
    position: relative;
    }

    .share-dropdown {
    position: absolute;
    top: 45px;
    right: 0;
    background-color: var(--background);
    border-radius: var(--radius);
    box-shadow: 0 5px 15px var(--shadow);
    padding: 10px;
    display: none;
    z-index: 10;
    }

    .share-dropdown.active {
    display: flex;
    gap: 10px;
    }

    .share-dropdown a {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--background-alt);
    color: var(--text);
    transition: var(--transition);
    }

    .share-dropdown a:hover {
    background-color: var(--primary-light);
    color: white;
    }

    /* レシピメイン */
    .recipe-main {
    margin-bottom: 60px;
    }

    .recipe-image-container {
    margin-bottom: 30px;
    border-radius: var(--radius);
    overflow: hidden;
    }

    .recipe-main-image {
    width: 100%;
    height: auto;
    object-fit: cover;
    display: block;
    }

    .recipe-info {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 40px;
    padding: 20px;
    background-color: var(--background-alt);
    border-radius: var(--radius);
    }

    .info-item {
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1;
    min-width: 150px;
    }

    .info-item i {
    font-size: 1.5rem;
    color: var(--primary);
    }

    .info-label {
    display: block;
    font-size: 0.8rem;
    color: var(--text-light);
    }

    .info-value {
    display: block;
    font-weight: 700;
    font-size: 1.1rem;
    }

    .recipe-content {
    display: grid;
    grid-template-columns: 1fr 2fr;
    gap: 40px;
    }

    .ingredients-section, .nutrition-section {
    grid-column: 1;
    }

    .instructions-section, .tips-section {
    grid-column: 2;
    }

    .recipe-content h2 {
    font-size: 1.5rem;
    margin-bottom: 20px;
    position: relative;
    padding-bottom: 10px;
    }

    .recipe-content h2::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    width: 50px;
    height: 3px;
    background-color: var(--primary);
    }

    .servings {
    font-size: 1rem;
    font-weight: normal;
    color: var(--text-light);
    }

    .servings-control {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    }

    .servings-btn {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: var(--background-alt);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    transition: var(--transition);
    }

    .servings-btn:hover {
    background-color: var(--primary);
    color: white;
    border-color: var(--primary);
    }

    .servings-value {
    font-weight: 700;
    font-size: 1.1rem;
    }

    .servings-text {
    color: var(--text-light);
    }

    .ingredients-list {
    margin-bottom: 30px;
    }

    .ingredients-list li {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    }

    .ingredient-name {
    flex: 1;
    }

    .ingredient-amount {
    font-weight: 500;
    color: var(--text-light);
    }

    .instructions-list {
    list-style-type: none;
    counter-reset: step-counter;
    margin-bottom: 30px;
    }

    .instruction-step {
    display: flex;
    gap: 15px;
    margin-bottom: 25px;
    }

    .step-number {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    background-color: var(--primary);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    flex-shrink: 0;
    }

    .step-content {
    flex: 1;
    }

    .step-content p {
    margin-bottom: 15px;
    }

    .step-image {
    margin-top: 15px;
    border-radius: var(--radius);
    overflow: hidden;
    }

    .step-image img {
    width: 100%;
    height: auto;
    display: block;
    }

    .tips-list {
    margin-bottom: 30px;
    }

    .tips-list li {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    }

    .tips-list i {
    color: var(--primary);
    margin-top: 3px;
    flex-shrink: 0;
    }

    .nutrition-table {
    margin-bottom: 15px;
    }

    .nutrition-row {
    display: flex;
    justify-content: space-between;
    padding: 10px 0;
    border-bottom: 1px solid var(--border);
    }

    .nutrition-name {
    font-weight: 500;
    }

    .nutrition-value {
    font-weight: 700;
    }

    .nutrition-note {
    font-size: 0.8rem;
    color: var(--text-light);
    margin-bottom: 30px;
    }

    /* PFCバランスチャート */
    .nutrition-chart {
        margin-bottom: 30px;
    }

    .nutrition-chart h3 {
        font-size: 1.2rem;
        margin-bottom: 15px;
        color: var(--text);
    }

    .chart-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 15px;
    }

    canvas#pfc-chart {
        max-width: 100%;
        margin-bottom: 15px;
    }

    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 10px;
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .legend-color {
        width: 15px;
        height: 15px;
        border-radius: 3px;
    }

    .legend-text {
        font-size: 0.9rem;
        color: var(--text-light);
    }

    .chart-note {
        text-align: center;
        font-size: 0.8rem;
        color: var(--text-light);
    }

    /* レビューセクション */
    .review-section {
    margin-bottom: 60px;
    }

    .rating-summary {
    display: flex;
    gap: 40px;
    margin-bottom: 30px;
    padding: 20px;
    background-color: var(--background-alt);
    border-radius: var(--radius);
    }

    .average-rating {
    text-align: center;
    }

    .rating-number {
    font-size: 3rem;
    font-weight: 700;
    line-height: 1;
    margin-bottom: 10px;
    }

    .rating-stars {
    color: var(--primary);
    font-size: 1.2rem;
    margin-bottom: 5px;
    }

    .rating-count {
    color: var(--text-light);
    font-size: 0.9rem;
    }

    .rating-distribution {
    flex: 1;
    }

    .rating-bar {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    }

    .rating-label {
    width: 15px;
    text-align: center;
    }

    .bar-container {
    flex: 1;
    height: 10px;
    background-color: var(--border);
    border-radius: 5px;
    overflow: hidden;
    }

    .bar {
    height: 100%;
    background-color: var(--primary);
    }

    .rating-percent {
    width: 40px;
    text-align: right;
    font-size: 0.9rem;
    color: var(--text-light);
    }

    .review-form {
    margin-bottom: 40px;
    padding: 20px;
    background-color: var(--background);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    }

    .review-form h3 {
    font-size: 1.2rem;
    margin-bottom: 20px;
    }

    .rating-input {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
    }

    .star-rating {
    display: flex;
    gap: 5px;
    color: var(--text-light);
    font-size: 1.2rem;
    cursor: pointer;
    }

    .star-rating i.fas {
    color: var(--primary);
    }

    .form-group {
    margin-bottom: 20px;
    }

    .form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 500;
    }

    .form-group input, .form-group textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    background-color: var(--background);
    color: var(--text);
    }

    .form-group textarea {
    height: 120px;
    resize: vertical;
    }

    .form-group input:focus, .form-group textarea:focus {
    outline: none;
    border-color: var(--primary);
    }

    .reviews-list {
    margin-top: 40px;
    }

    .review-item {
    padding: 20px;
    border-bottom: 1px solid var(--border);
    }

    .review-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 10px;
    }

    .reviewer-name {
    font-weight: 500;
    }

    .review-date {
    font-size: 0.9rem;
    color: var(--text-light);
    }

    .review-rating {
    color: var(--primary);
    }

    .review-content p {
    line-height: 1.6;
    }

    .load-more-reviews {
    margin-top: 20px;
    width: 100%;
    }

    /* 関連レシピ */
    .related-recipes {
    margin-bottom: 60px;
    }

    .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 30px;
    }

    /* レスポンシブデザイン */
    @media (max-width: 992px) {
      .recipe-header {
        flex-wrap: wrap;
      }

      .recipe-title h1 {
        font-size: 1.5rem;
      }

      .recipe-subtitle {
        font-size: 1rem;
      }

      .recipe-actions {
        width: 100%;
        justify-content: flex-start;
        margin-top: 1rem;
      }
    .recipe-content {
        grid-template-columns: 1fr;
        gap: 30px;
    }

    .ingredients-section, .nutrition-section, .instructions-section, .tips-section {
        grid-column: 1;
    }

    .rating-summary {
        flex-direction: column;
        gap: 20px;
    }

    .related-grid {
        grid-template-columns: repeat(2, 1fr);
    }

        canvas#pfc-chart {
        width: 220px;
        height: 220px;
        }
    }

    @media (max-width: 576px) {
    .related-grid {
        grid-template-columns: 1fr;
    }

    .review-header {
        flex-direction: column;
        gap: 5px;
    }

        canvas#pfc-chart {
        width: 200px;
        height: 200px;
        }
    }
</style>

<script>
    // レビュー星評価
  const starRating = document.querySelectorAll('.star-rating i');
  let currentRating = 0;

  starRating.forEach(star => {
    // マウスオーバー時
    star.addEventListener('mouseover', function() {
      const rating = parseInt(this.getAttribute('data-rating'));

      starRating.forEach(s => {
        const sRating = parseInt(s.getAttribute('data-rating'));
        if (sRating <= rating) {
          s.classList.remove('far');
          s.classList.add('fas');
        } else {
          s.classList.remove('fas');
          s.classList.add('far');
        }
      });
    });

    // マウスアウト時
    star.addEventListener('mouseout', function() {
      starRating.forEach(s => {
        const sRating = parseInt(s.getAttribute('data-rating'));
        if (sRating <= currentRating) {
          s.classList.remove('far');
          s.classList.add('fas');
        } else {
          s.classList.remove('fas');
          s.classList.add('far');
        }
      });
    });

    // クリック時
    star.addEventListener('click', function() {
      currentRating = parseInt(this.getAttribute('data-rating'));

      starRating.forEach(s => {
        const sRating = parseInt(s.getAttribute('data-rating'));
        if (sRating <= currentRating) {
          s.classList.remove('far');
          s.classList.add('fas');
        } else {
          s.classList.remove('fas');
          s.classList.add('far');
        }
      });
    });
  });

  // レビュー投稿
  {% comment %} const reviewForm = document.querySelector('.review-form');
  const reviewNameInput = document.getElementById('review-name');
  const reviewCommentInput = document.getElementById('review-comment');
  const reviewSubmitBtn = reviewForm.querySelector('.btn');

  reviewSubmitBtn.addEventListener('click', function(e) {
    e.preventDefault();

    const name = reviewNameInput.value.trim();
    const comment = reviewCommentInput.value.trim();

    if (currentRating === 0) {
      showToast('評価を選択してください', 'error');
      return;
    }

    if (name === '') {
      showToast('名前を入力してください', 'error');
      return;
    }

    if (comment === '') {
      showToast('コメントを入力してください', 'error');
      return;
    }

    // 実際のプロジェクトではここでAjaxリクエストを送信

    // レビュー投稿成功のシミュレーション
    showToast('レビューを投稿しました。ありがとうございます！');

    // フォームをリセット
    reviewNameInput.value = '';
    reviewCommentInput.value = '';
    currentRating = 0;
    starRating.forEach(s => {
      s.classList.remove('fas');
      s.classList.add('far');
    });
  }); {% endcomment %}

    document.addEventListener('DOMContentLoaded', function() {
        // お気に入りボタン
        const favoriteBtn = document.querySelector('.favorite-btn');

        favoriteBtn.addEventListener('click', function() {
          this.classList.toggle('active');

          if (this.classList.contains('active')) {
            this.innerHTML = '<i class="fas fa-heart"></i>';
            showToast('お気に入りに追加しました');
          } else {
            this.innerHTML = '<i class="far fa-heart"></i>';
            showToast('お気に入りから削除しました');
          }
        });

        // シェアボタン
        const shareBtn = document.querySelector('.share-btn');
        const shareDropdown = document.querySelector('.share-dropdown');

        shareBtn.addEventListener('click', function() {
          shareDropdown.classList.toggle('active');
        });

        // ドロップダウン外クリックで閉じる
        document.addEventListener('click', function(event) {
          if (!event.target.closest('.recipe-share')) {
            shareDropdown.classList.remove('active');
          }
        });

        // 印刷ボタン
        const printBtn = document.querySelector('.print-btn');

        printBtn.addEventListener('click', function() {
          window.print();
        });

        // 人数調整
        const decreaseBtn = document.querySelector('[data-action="decrease"]');
        const increaseBtn = document.querySelector('[data-action="increase"]');
        const servingsValue = document.querySelector('.servings-value');
        const servingsText = document.querySelector('.servings');
        const ingredientAmounts = document.querySelectorAll('.ingredient-amount');



        decreaseBtn.addEventListener('click', function() {
          let currentValue = parseInt(servingsValue.textContent);
          if (currentValue > 1) {
            currentValue--;
            updateServings(currentValue);
          }
        });

        increaseBtn.addEventListener('click', function() {
          let currentValue = parseInt(servingsValue.textContent);
          if (currentValue < 10) {
            currentValue++;
            updateServings(currentValue);
          }
        });

        function updateServings(value) {
            console.log(servingsValue.textContent);
            // 元の分量を保存
          const originalAmounts = [];
          ingredientAmounts.forEach(amount => {
            console.log(parseFloat(amount.textContent));
            originalAmounts.push(amount.textContent);
          });
          // 材料の分量を調整
          const ratio = value / parseInt(servingsValue.textContent); // 元のレシピは2人分
          servingsValue.textContent = value;
          servingsText.textContent = `(${value}人分)`;

          console.log(ingredientAmounts);

          ingredientAmounts.forEach((amount, index) => {
            const original = originalAmounts[index];
            console.log(original);
            // 「お好みで」などの数値でない表記はスキップ
            if (original.match(/\d+/)) {
              // 数値を抽出して計算
              const match = original.match(/(\d+(?:\.\d+)?)/);
              if (match) {
                const originalValue = parseFloat(match[0]);
                const newValue = (originalValue * ratio).toFixed(1).replace(/\.0$/, '');
                amount.textContent = original.replace(match[0], newValue);
              }
            }
          });
        }

        // PFCバランスレーダーチャート
        const canvas = document.getElementById('pfc-chart');
        if (canvas) {
          const ctx = canvas.getContext('2d');

          // 栄養データ（このレシピのPFCバランス）
          const recipeData = {
            protein: 25, // タンパク質（g）
            fat: 10,     // 脂質（g）
            carbs: 35    // 炭水化物（g）
          };

          // カロリー計算
          const proteinCalories = recipeData.protein * 4;  // タンパク質は1gあたり4kcal
          const fatCalories = recipeData.fat * 9;          // 脂質は1gあたり9kcal
          const carbsCalories = recipeData.carbs * 4;      // 炭水化物は1gあたり4kcal
          const totalCalories = proteinCalories + fatCalories + carbsCalories;

          // パーセント計算
          const proteinPercent = (proteinCalories / totalCalories) * 100;
          const fatPercent = (fatCalories / totalCalories) * 100;
          const carbsPercent = (carbsCalories / totalCalories) * 100;

          // 理想的なPFCバランス（例: P:30%, F:20%, C:50%）
          const idealBalance = {
            protein: 30,
            fat: 20,
            carbs: 50
          };

          // レーダーチャートを描画
          drawPFCRadarChart(ctx, {
            current: {
              protein: Math.round(proteinPercent),
              fat: Math.round(fatPercent),
              carbs: Math.round(carbsPercent)
            },
            ideal: idealBalance
          });

          // ウィンドウリサイズ時にチャートを再描画
          window.addEventListener('resize', function() {
            drawPFCRadarChart(ctx, {
              current: {
                protein: Math.round(proteinPercent),
                fat: Math.round(fatPercent)
              },
              ideal: idealBalance
            });
          });

          // ダークモード切替時にチャートを再描画
          const themeToggle = document.querySelector('.theme-toggle');
          themeToggle.addEventListener('click', function() {
            setTimeout(() => {
              drawPFCRadarChart(ctx, {
                current: {
                  protein: Math.round(proteinPercent),
                  fat: Math.round(fatPercent),
                  carbs: Math.round(carbsPercent)
                },
                ideal: idealBalance
              });
            }, 100);
          });
        }

        // レーダーチャート描画関数
        function drawPFCRadarChart(ctx, data) {
          // キャンバスをクリア
          ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

          const width = ctx.canvas.width;
          const height = ctx.canvas.height;
          const centerX = width / 2;
          const centerY = height / 2;
          const radius = Math.min(centerX, centerY) * 0.8;

          // ダークモード対応のテキスト色
          const textColor = getComputedStyle(document.documentElement).getPropertyValue('--text').trim();
          const gridColor = getComputedStyle(document.documentElement).getPropertyValue('--border').trim();

          // グリッドを描画
          ctx.strokeStyle = gridColor;
          ctx.lineWidth = 0.5;

          // 外枠の三角形
          ctx.beginPath();
          for (let i = 0; i < 3; i++) {
            const angle = (Math.PI * 2 * i) / 3 - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }
          ctx.closePath();
          ctx.stroke();

          // 内側のグリッド（50%、25%の円）
          for (let percentage of [0.5, 0.25]) {
            ctx.beginPath();
            for (let i = 0; i < 3; i++) {
              const angle = (Math.PI * 2 * i) / 3 - Math.PI / 2;
              const x = centerX + radius * percentage * Math.cos(angle);
              const y = centerY + radius * percentage * Math.sin(angle);
              if (i === 0) {
                ctx.moveTo(x, y);
              } else {
                ctx.lineTo(x, y);
              }
            }
            ctx.closePath();
            ctx.stroke();
          }

          // 中心から各頂点への線
          for (let i = 0; i < 3; i++) {
            ctx.beginPath();
            const angle = (Math.PI * 2 * i) / 3 - Math.PI / 2;
            const x = centerX + radius * Math.cos(angle);
            const y = centerY + radius * Math.sin(angle);
            ctx.moveTo(centerX, centerY);
            ctx.lineTo(x, y);
            ctx.stroke();
          }

          // ラベルを描画
          ctx.fillStyle = textColor;
          ctx.font = '14px "Noto Sans JP", sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          // タンパク質（上）
          const proteinAngle = -Math.PI / 2;
          let labelX = centerX + (radius + 20) * Math.cos(proteinAngle);
          let labelY = centerY + (radius + 20) * Math.sin(proteinAngle);
          ctx.fillText('P', labelX, labelY);

          // 脂質（右下）
          const fatAngle = (Math.PI * 2 * 1) / 3 - Math.PI / 2;
          labelX = centerX + (radius + 20) * Math.cos(fatAngle);
          labelY = centerY + (radius + 20) * Math.sin(fatAngle);
          ctx.fillText('F', labelX, labelY);

          // 炭水化物（左下）
          const carbsAngle = (Math.PI * 2 * 2) / 3 - Math.PI / 2;
          labelX = centerX + (radius + 20) * Math.cos(carbsAngle);
          labelY = centerY + (radius + 20) * Math.sin(carbsAngle);
          ctx.fillText('C', labelX, labelY);

          // 理想のバランスを描画
          drawDataPolygon(ctx, data.ideal, centerX, centerY, radius, 'rgba(255, 122, 0, 0.2)');

          // 実際のバランスを描画
          drawDataPolygon(ctx, data.current, centerX, centerY, radius, 'rgba(255, 122, 0, 0.7)');

          // 数値を表示
          ctx.font = '12px "Noto Sans JP", sans-serif';
          ctx.fillStyle = textColor;

          // タンパク質の数値
          let valueX = centerX + (radius * 0.4) * Math.cos(proteinAngle);
          let valueY = centerY + (radius * 0.4) * Math.sin(proteinAngle);
          ctx.fillText(`${data.current.protein}%`, valueX, valueY);

          // 脂質の数値
          valueX = centerX + (radius * 0.4) * Math.cos(fatAngle);
          valueY = centerY + (radius * 0.4) * Math.sin(fatAngle);
          ctx.fillText(`${data.current.fat}%`, valueX, valueY);

          // 炭水化物の数値
          valueX = centerX + (radius * 0.4) * Math.cos(carbsAngle);
          valueY = centerY + (radius * 0.4) * Math.sin(carbsAngle);
          ctx.fillText(`${data.current.carbs}%`, valueX, valueY);
        }

        // データポリゴンを描画する関数
        function drawDataPolygon(ctx, data, centerX, centerY, radius, fillColor) {
          const maxValue = 100; // 100%を最大値とする
          ctx.beginPath();

          // 各データポイントを描画
          for (let i = 0; i < 3; i++) {
            const angle = (Math.PI * 2 * i) / 3 - Math.PI / 2;
            let value;

            if (i === 0) value = data.protein;
            else if (i === 1) value = data.fat;
            else value = data.carbs;

            // 値を0-1の範囲に正規化
            const normalizedValue = value / maxValue;
            const x = centerX + radius * normalizedValue * Math.cos(angle);
            const y = centerY + radius * normalizedValue * Math.sin(angle);

            if (i === 0) {
              ctx.moveTo(x, y);
            } else {
              ctx.lineTo(x, y);
            }
          }

          ctx.closePath();
          ctx.fillStyle = fillColor;
          ctx.fill();

          // 輪郭線を描画
          ctx.strokeStyle = fillColor.replace('0.2', '1').replace('0.7', '1');
          ctx.lineWidth = 2;
          ctx.stroke();
        }

        // トースト通知
        function showToast(message, type = 'success') {
          // 既存のトーストを削除
          const existingToast = document.querySelector('.toast');
          if (existingToast) {
            existingToast.remove();
          }

          // 新しいトーストを作成
          const toast = document.createElement('div');
          toast.className = `toast ${type}`;
          toast.textContent = message;

          document.body.appendChild(toast);

          // アニメーション
          setTimeout(() => {
            toast.classList.add('show');
          }, 10);

          // 自動的に消える
          setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => {
              toast.remove();
            }, 300);
          }, 3000);
        }

        // CSSをページに追加
        const style = document.createElement('style');
        style.textContent = `
          .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: var(--radius);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
          }

          .toast.show {
            transform: translateY(0);
            opacity: 1;
          }

          .toast.error {
            background-color: #e74c3c;
          }

          @media print {
            header, footer, .recipe-actions, .review-section, .related-recipes, .breadcrumbs {
              display: none !important;
            }

            .recipe-content {
              display: block;
            }

            .recipe-detail {
              padding: 0;
            }
          }
        `;
        document.head.appendChild(style);
      });
</script>

{% endblock %}